{% extends "base.html" %}
{% block title %}Detección de Hongos{% endblock %}

{% block extra_styles %}
<style>
    .content-title {
        text-align: center;
    }


    #videoContainer {
        max-width: 100%;
        display: flex;
        justify-content: center;
    }

    video {
        width: 100%;
        max-width: 100%;
        height: auto;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        margin-top: 1rem;
        border: 3px solid transparent;
        transition: border 0.3s ease-in-out;
    }

    .video-active {
        border-color: #28a745;
    }

    #detectionsContainer {
        margin-top: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
    }

    .detection-img {
        max-width: 250px;
        border: 2px solid #ccc;
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-title mt-4">
    <h2>Detección en Tiempo Real - Fruto del Tangelo</h2>
    <button onclick="startCamera()" class="btn btn-primary">Iniciar</button>
    <button onclick="stopCamera()" class="btn btn-danger">Detener</button>
</div>


<div class="container mt-2 mb-2 d-flex justify-content-center">
    <div class="alert alert-light w-auto p-2 border border-dark-subtle" role="alert">
        <h4 class="alert-heading">Surgerencias</h4>
        <ol>
            <li>Posiciona la cámara de forma que los tangelos pasen claramente por el área de captura.</li>
            <li>Para comenzar con la detección, presiona el botón "Iniciar".</li>
            <li>La detección se realiza automáticamente:
                <ul>
                    <li>Solo se guardarán imágenes donde se detecte un tangelo afectado o sano.</li>
                    <li>Las imágenes sin detección serán descartadas.</li>
                </ul>
            </li>
            <li>Para detener la detección, presiona el botón "Detener".</li>
        </ol>
    </div>
</div>

<div id="videoContainer" class="mt-2">
    <!-- <video id="videoFeed" class="video-active" autoplay playsinline style="display: block;"></video> -->
    <video id="videoFeed" autoplay playsinline style="display: none;"></video>
</div>

<div id="detectionsContainer">
</div>

<script>
    const videoFeed = document.getElementById('videoFeed');
    const detectionsContainer = document.getElementById('detectionsContainer');
    let currentStream = null;
    let intervalId = null;

    async function startCamera() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    currentStream = stream;
                    videoFeed.srcObject = stream;
                    videoFeed.style.display = 'block';
                    videoFeed.classList.add('video-active');

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    intervalId = setInterval(async () => {
                        if (!videoFeed.videoWidth) return;

                        canvas.width = videoFeed.videoWidth;
                        canvas.height = videoFeed.videoHeight;
                        ctx.drawImage(videoFeed, 0, 0, canvas.width, canvas.height);
                        const imageData = canvas.toDataURL('image/jpeg');

                        try {
                            const response = await fetch('/analizar_frame', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ image: imageData })
                            });

                            const data = await response.json();

                            if (data.image) {
                                const img = document.createElement('img');
                                img.src = data.image;
                                img.alt = "Resultado de detección";
                                img.classList.add('detection-img');
                                detectionsContainer.prepend(img); // Mostrar la detección más reciente primero
                            }
                        } catch (err) {
                            console.error("Error procesando el frame:", err);
                        }
                    }, 2000);
                })
                .catch(err => {
                    console.error("Error al acceder a la cámara: ", err);
                });
        } else {
            console.error("El navegador no soporta acceso a la cámara.");
        }
    }

    function stopCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
        }
        clearInterval(intervalId);
        videoFeed.srcObject = null;
        videoFeed.style.display = 'none';
        videoFeed.classList.remove('video-active');
    }
</script>
{% endblock %}